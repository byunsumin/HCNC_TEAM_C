<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="hcnc.cteam.employee.HrdMapper">
	<select id="getHrdList" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT e.emp_code AS emp_code,
				e.name AS name, 
				e.mng_code AS mng_code, 
				d.dep_name AS dep_name,
				e.dep_code AS dep_code,
				e.assign_code AS assign_code, 
				a.assign_name AS assign_name,
				COALESCE((SELECT name
				FROM employee e3
				WHERE e3.emp_code = e.mng_code), '-') AS mng_name,
				to_char(e.join_date,'YYYYMMDD') AS join_date,
				to_char(e.resign_date,'YYYYMMDD') AS resign_date
		FROM employee e  LEFT JOIN `assignment` a 
			ON e.assign_code = a.assign_code LEFT JOIN department d 
			ON e.dep_code = d.dep_code 
		WHERE 1=1
		<if test="SEARCH_WORD != null and SEARCH_WORD != '' and SEARCH_TYPE != '' and SEARCH_TYPE != null">
			<if test="SEARCH_TYPE == 'ALL'">
				AND (e.name LIKE CONCAT('%',#{SEARCH_WORD},'%') 
				OR e.dep_name LIKE CONCAT('%',#{SEARCH_WORD},'%')
				OR e.emp_code LIKE CONCAT('%',#{SEARCH_WORD},'%')
				OR a.assign_name LIKE CONCAT('%',#{SEARCH_WORD},'%')
				)
			</if>
			<if test="SEARCH_TYPE =='EMP_CODE'">
				AND e.emp_code LIKE CONCAT('%',#{SEARCH_WORD},'%')
			</if>
			<if test="SEARCH_TYPE == 'NAME'">
				AND e.name LIKE CONCAT('%',#{SEARCH_WORD},'%')
			</if>
			<if test="SEARCH_TYPE == 'DEP_NAME'">
				AND d.dep_name LIKE CONCAT('%',#{SEARCH_WORD},'%')
			</if>
		</if>
	</select>
	
	<update id="updateHRD" parameterType="java.util.Map">
	   UPDATE employee 
		SET assign_code = #{assign_code},
			dep_code= #{dep_code},
			join_date =#{join_date},
			resign_date =#{resign_date},
			upd_name = #{admin_name}
		WHERE emp_code = #{emp_code} ;
	</update>
	
	
	<update id="updateMng">
		UPDATE employee e1
		SET mng_code = (
		    CASE
		        WHEN 5 > e1.assign_code  THEN (
		            SELECT e2.emp_code
		            FROM employee e2
		            WHERE e2.dep_code = e1.dep_code
		            AND e2.assign_code = 5
		            LIMIT 1
		        )
		        WHEN e1.assign_code >= 5 THEN (
		            SELECT e2.emp_code
		            FROM employee e2
		            WHERE e2.assign_code = 7
		            LIMIT 1
		        )
		        ELSE NULL 
		    END
		)
	</update>
	

</mapper>